import streamlit as st
import numpy as np
from PIL import Image
import io
from sirds_generator import SIRDSGenerator

# –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
st.set_page_config(
    page_title="SIRDS Stereogram Generator",
    page_icon="üëÅÔ∏è",
    layout="wide"
)

# –ó–∞–≥–æ–ª–æ–≤–æ–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
st.title("üîç SIRDS Stereogram Generator")
st.markdown("**–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º –∏–∑ –≤–∞—à–∏—Ö –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π**")

# –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ SIRDS
with st.expander("‚ÑπÔ∏è –ß—Ç–æ —Ç–∞–∫–æ–µ SIRDS –∏ –∫–∞–∫ –∏—Ö —Å–º–æ—Ç—Ä–µ—Ç—å?"):
    st.markdown("""
    **SIRDS (Single Image Random Dot Stereograms)** - —ç—Ç–æ –æ—Å–æ–±—ã–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è, —Å–æ–¥–µ—Ä–∂–∞—â–∏–µ —Å–∫—Ä—ã—Ç—ã–µ 3D –æ–±—ä–µ–∫—Ç—ã.
    
    **–ö–∞–∫ —Å–º–æ—Ç—Ä–µ—Ç—å —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—ã:**
    1. –ü–æ–º–µ—Å—Ç–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –Ω–∞ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏ 30-50 —Å–º –æ—Ç –≥–ª–∞–∑
    2. –°–º–æ—Ç—Ä–∏—Ç–µ —Å–∫–≤–æ–∑—å –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ, –∫–∞–∫ –±—É–¥—Ç–æ –ø—ã—Ç–∞–µ—Ç–µ—Å—å —É–≤–∏–¥–µ—Ç—å —á—Ç–æ-—Ç–æ –¥–∞–ª–µ–∫–æ –∑–∞ –Ω–∏–º
    3. –†–∞—Å—Å–ª–∞–±—å—Ç–µ –≥–ª–∞–∑–∞ –∏ –Ω–µ —Ñ–æ–∫—É—Å–∏—Ä—É–π—Ç–µ—Å—å –Ω–∞ –ø–æ–≤–µ—Ä—Ö–Ω–æ—Å—Ç–∏ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
    4. –ß–µ—Ä–µ–∑ –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è –≤—ã —É–≤–∏–¥–∏—Ç–µ —Å–∫—Ä—ã—Ç–æ–µ 3D –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
    
    **–°–æ–≤–µ—Ç:** –ù–µ–∫–æ—Ç–æ—Ä—ã–º –ª—é–¥—è–º –ø—Ä–æ—â–µ –Ω–∞—á–∞—Ç—å —Å –ø—Ä–∏–±–ª–∏–∂–µ–Ω–∏—è –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∫ –Ω–æ—Å—É, –∞ –∑–∞—Ç–µ–º –º–µ–¥–ª–µ–Ω–Ω–æ –æ—Ç–æ–¥–≤–∏–≥–∞—Ç—å –µ–≥–æ.
    """)

# –ë–æ–∫–æ–≤–∞—è –ø–∞–Ω–µ–ª—å —Å –Ω–∞—Å—Ç—Ä–æ–π–∫–∞–º–∏
st.sidebar.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏")

# –ü–∞—Ä–∞–º–µ—Ç—Ä—ã SIRDS
dot_size = st.sidebar.slider(
    "–†–∞–∑–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –ø–∞—Ç—Ç–µ—Ä–Ω–∞",
    min_value=1,
    max_value=5,
    value=2,
    help="–†–∞–∑–º–µ—Ä —ç–ª–µ–º–µ–Ω—Ç–æ–≤ –≤ —Ñ—Ä–∞–∫—Ç–∞–ª—å–Ω–æ–º –ø–∞—Ç—Ç–µ—Ä–Ω–µ"
)

depth_intensity = st.sidebar.slider(
    "–ò–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å 3D —ç—Ñ—Ñ–µ–∫—Ç–∞",
    min_value=0.1,
    max_value=2.0,
    value=1.2,
    step=0.1,
    help="–ù–∞—Å–∫–æ–ª—å–∫–æ –≤—ã—Ä–∞–∂–µ–Ω–æ —Ç—Ä—ë—Ö–º–µ—Ä–Ω–æ–µ –≤–æ—Å–ø—Ä–∏—è—Ç–∏–µ –æ–±—ä–µ–∫—Ç–∞"
)

pattern_width = st.sidebar.slider(
    "–®–∏—Ä–∏–Ω–∞ –ø–∞—Ç—Ç–µ—Ä–Ω–∞",
    min_value=50,
    max_value=200,
    value=100,
    help="–®–∏—Ä–∏–Ω–∞ –ø–æ–≤—Ç–æ—Ä—è—é—â–µ–≥–æ—Å—è –ø–∞—Ç—Ç–µ—Ä–Ω–∞ –≤ –ø–∏–∫—Å–µ–ª—è—Ö"
)

output_width = st.sidebar.selectbox(
    "–®–∏—Ä–∏–Ω–∞ –≤—ã—Ö–æ–¥–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è",
    [400, 600, 800, 1000, 1200],
    index=2,
    help="–®–∏—Ä–∏–Ω–∞ —Ñ–∏–Ω–∞–ª—å–Ω–æ–π —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—ã"
)

# –û—Å–Ω–æ–≤–Ω–∞—è –æ–±–ª–∞—Å—Ç—å
col1, col2 = st.columns(2)

with col1:
    st.header("üì§ –ó–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è")
    
    uploaded_file = st.file_uploader(
        "–í—ã–±–µ—Ä–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ",
        type=['png', 'jpg', 'jpeg'],
        help="–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PNG, JPG, JPEG"
    )
    
    if uploaded_file is not None:
        # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø—Ä–µ–≤—å—é –∑–∞–≥—Ä—É–∂–µ–Ω–Ω–æ–≥–æ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è
        image = Image.open(uploaded_file)
        st.image(image, caption="–ò—Å—Ö–æ–¥–Ω–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ", use_container_width=True)
        
        # –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ–± –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–∏
        st.info(f"–†–∞–∑–º–µ—Ä: {image.size[0]}x{image.size[1]} –ø–∏–∫—Å–µ–ª–µ–π")

with col2:
    st.header("üéØ –†–µ–∑—É–ª—å—Ç–∞—Ç")
    
    if uploaded_file is not None:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ
        image = Image.open(uploaded_file)
        
        try:
            # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            with st.spinner("–ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—É..."):
                # –°–æ–∑–¥–∞–µ–º –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä SIRDS
                generator = SIRDSGenerator()
                
                # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—É
                sirds_image = generator.generate_sirds(
                    image,
                    dot_size=dot_size,
                    depth_intensity=depth_intensity,
                    pattern_width=pattern_width,
                    output_width=output_width
                )
                
                # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –æ—Ç–∫—Ä—ã—Ç—å –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
                st.image(sirds_image, caption="SIRDS –°—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º–∞", use_container_width=True)
                
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ –≤ –ø–æ–ª–Ω–æ—ç–∫—Ä–∞–Ω–Ω–æ–º —Ä–µ–∂–∏–º–µ
                if st.button("üîç –û—Ç–∫—Ä—ã—Ç—å –≤ –ø–æ–ª–Ω–æ–º —Ä–∞–∑–º–µ—Ä–µ", use_container_width=True):
                    st.image(sirds_image, caption="SIRDS –°—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º–∞ - –ü–æ–ª–Ω—ã–π —Ä–∞–∑–º–µ—Ä")
                
                # –ö–Ω–æ–ø–∫–∞ –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
                buf = io.BytesIO()
                sirds_image.save(buf, format='PNG')
                byte_im = buf.getvalue()
                
                st.download_button(
                    label="üì• –°–∫–∞—á–∞—Ç—å —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—É",
                    data=byte_im,
                    file_name="stereogram.png",
                    mime="image/png",
                    use_container_width=True
                )
                
        except Exception as e:
            st.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—ã: {str(e)}")
            st.info("–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥—Ä—É–≥–æ–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å –Ω–∞—Å—Ç—Ä–æ–π–∫–∏.")
    else:
        st.info("üëÜ –ó–∞–≥—Ä—É–∑–∏—Ç–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å—Ç–µ—Ä–µ–æ–≥—Ä–∞–º–º—ã")

# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
st.markdown("---")
st.markdown("### üí° –°–æ–≤–µ—Ç—ã –¥–ª—è –ª—É—á—à–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤:")
col1, col2, col3 = st.columns(3)

with col1:
    st.markdown("""
    **–ü–æ–¥—Ö–æ–¥—è—â–∏–µ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è:**
    - –ü—Ä–æ—Å—Ç—ã–µ —Ñ–æ—Ä–º—ã –∏ –æ–±—ä–µ–∫—Ç—ã
    - –í—ã—Å–æ–∫–∏–π –∫–æ–Ω—Ç—Ä–∞—Å—Ç
    - –ß–µ—Ç–∫–∏–µ –≥—Ä–∞–Ω–∏—Ü—ã
    """)

with col2:
    st.markdown("""
    **–ù–∞—Å—Ç—Ä–æ–π–∫–∏:**
    - –ù–∞—á–Ω–∏—Ç–µ —Å –±–∞–∑–æ–≤—ã—Ö –Ω–∞—Å—Ç—Ä–æ–µ–∫
    - –£–≤–µ–ª–∏—á—å—Ç–µ –∏–Ω—Ç–µ–Ω—Å–∏–≤–Ω–æ—Å—Ç—å –¥–ª—è –±–æ–ª–µ–µ –≤—ã—Ä–∞–∂–µ–Ω–Ω–æ–≥–æ —ç—Ñ—Ñ–µ–∫—Ç–∞
    - –≠–∫—Å–ø–µ—Ä–∏–º–µ–Ω—Ç–∏—Ä—É–π—Ç–µ —Å —Ä–∞–∑–º–µ—Ä–æ–º –ø–∞—Ç—Ç–µ—Ä–Ω–∞
    """)

with col3:
    st.markdown("""
    **–ü—Ä–æ—Å–º–æ—Ç—Ä:**
    - –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ —Ö–æ—Ä–æ—à–µ–µ –æ—Å–≤–µ—â–µ–Ω–∏–µ
    - –†–∞—Å—Å–ª–∞–±—å—Ç–µ –≥–ª–∞–∑–∞
    - –ë—É–¥—å—Ç–µ —Ç–µ—Ä–ø–µ–ª–∏–≤—ã - –º–æ–∂–µ—Ç –ø–æ—Ç—Ä–µ–±–æ–≤–∞—Ç—å—Å—è –≤—Ä–µ–º—è
    """)

# –§—É—Ç–µ—Ä
st.markdown("---")
st.markdown(
    "<div style='text-align: center; color: #666;'>"
    "–°–æ–∑–¥–∞–Ω–æ —Å ‚ù§Ô∏è –¥–ª—è –ª—é–±–∏—Ç–µ–ª–µ–π 3D –∏—Å–∫—É—Å—Å—Ç–≤–∞"
    "</div>",
    unsafe_allow_html=True
)
